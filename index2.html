<html>
    <head>
        <link rel="stylesheet" type="text/css" href="pref_style.css">
    </head>
    <body onload="init()">
        <h2 id="title"> Welcome to DesktopFlush </h2>
        <br>
        <p id="desc">
            We will help you remove all the crap from your desktop!
        </p>
        <br />
        Desktop Folder Name: <input id="desktopFolderName" type="text" placeholder="DesktopFlush" onblur="updateFolderName()"/>

        <br>
        Number of Groups:

        <select name="numGroups" id="numGroupSelector">
            <option value="" disabled selected>Number of Groups</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>

        <br />

        <button id="autoGroup" onclick="autoGroup()"> Auto Group</button>

        <div id="windowNames">

        </div>

        <div id="foldersCheckbox">

        </div>

        <br />
        <button id="okButton" onclick="start()"> OK </button>
    </body>

    <script>
        const fse = require("fs-extra");
        const remote = require("electron").remote;
        const path = require("path");

        var batchedWindowCreating = require('electron').remote.require('./main').batchedWindowCreating;

        var folders; // a list of the folders/files on the desktop

         //list of the windows, (each index is an object with the info about that window: title, and folders in it).
         // To be sent to the main to create the windows
        var data = [];

        function init(){
            folders = fse.readdirSync(remote.getGlobal('sharedObj').desktopPath).filter(function (f){
                return f[0]!='.';
            });

            var radioButtons = document.querySelector("#foldersCheckbox");

            document.getElementById('numGroupSelector').onchange = function() {
                data = [];
                var numOfGroups = this.value;
                radioButtons.innerHTML = "";

                var windowsDiv = document.querySelector("#windowNames");
                windowsDiv.innerHTML = "";

                for (var i = 0; i < numOfGroups; i++){
                    data.push([]);
                    data[i] = {};
                    data[i]["windowTitle"] = "";
                    data[i]["folders"] = [];
                    var windowNameInput = document.createElement("input");
                    windowNameInput.type = "text";
                    windowNameInput.setAttribute("placeholder", "Window " + (i+1));
                    windowNameInput.id = "windowName" + (i+1);
                    windowNameInput.className = "windowNameInput";
                    windowsDiv.appendChild(windowNameInput);
                }

                for (var i = 0; i < folders.length; i++){
                    var radioButtonContainer = document.createElement("div");

                    for (var j = 0; j < numOfGroups; j++){
                        var radioButton = document.createElement("input");
                        radioButton.type="radio";
                        radioButton.value = (j + 1);
                        radioButton.name = folders[i];
                        radioButton.id = "__" + folders[i] + "_Window" + j;
                        radioButton.className = "radioButton";
                        radioButtonContainer.appendChild(radioButton);

                    }
                    var label = document.createElement("label");
                    label.htmlFor = "__" + folders[i];
                    label.innerHTML = folders[i];

                    radioButtonContainer.appendChild(label);

                    radioButtons.appendChild(radioButtonContainer);
                }
            };
        }


        function updateFolderName(){

            var folderName = document.getElementById("desktopFolderName").value;
            console.log(folderName);
            if (folderName != ""){
                remote.getGlobal("sharedObj").appFolder = folderName;
            }
        }

        function start(){

            console.log(data);
            for (var i = 0; i < folders.length; i++){
                var radioButtons = document.getElementsByName(folders[i]);
                console.log(radioButtons);
                for (var j = 0; j < radioButtons.length; j++){
                    var windowNum = radioButtons[j].value;

                    data[windowNum-1]["windowTitle"] = document.getElementById("windowName" + windowNum).value;

                    if (radioButtons[j].checked){
                        data[windowNum-1]["folders"].push(folders[i]);
                        // console.log(folders[i] + "-> " + radioButtons[j].value);
                    }
                }

            }
            console.log(data);

            batchedWindowCreating(data);
            // var radioButtons = document.querySelectorAll('input[name=Screenshot]:checked');
            // for (var i = 0; i < radioButtons.length; i++){
            //     console.log(radioButtons[i].value);
            // }
        }

        function addToGroup(groupName, fileName, dict){
            if (groupName in dict){
                var index = dict[groupName];
                data[index].folders.push(fileName);
            } else{
                dict[groupName] = data.length;
                data.push({"windowTitle": groupName, "folders": [fileName]});
            }
        }

        function autoGroup(){

            // a dict group -> index (of the group) in the data list
            var groupsIndices = {};

            // go over the different folders on the desktopÂ§
            for (var i = 0; i < folders.length; i++){

                var file = folders[i];
                if (file == "$RECYCLE.BIN" || file == "All Your Desktop Groups Files" || file == "Screenshot"){
                    console.log("true");
                    continue;
                }

                // get the extension for the file - if folder no extension and if app it will be .app
               var extension = path.extname(file);

               var filePath = remote.getGlobal('sharedObj').desktopPath + "/" + file;
               console.log(filePath);

               // check if the new element is a directory
               if (fse.statSync(filePath).isDirectory()) {
                   if (extension == ".app"){ // if it is an app
                       addToGroup("app", file, groupsIndices);
                   } else{ // if it is a normal folder, show the regular folder icon
                        addToGroup("dir", file, groupsIndices);
                   }
               }
               else{  // it is a file, group them based on extension
                   switch(extension){
                       case ".pdf":
                           addToGroup("PDF", file, groupsIndices);
                           break;
                       case ".pages":
                       case ".doc":
                       case ".docx":
                           addToGroup("Documents", file, groupsIndices);
                           break;
                       case ".xlsx":
                       case ".numbers":
                           addToGroup("Stylesheet", file, groupsIndices);
                           break;
                       case ".key":
                       case ".ppt":
                           addToGroup("Presentation", file, groupsIndices);
                           break;
                       case ".txt":
                           addToGroup("txt", file, groupsIndices);
                           break;
                       case "tiff":
                       case ".png":
                       case ".jpg":
                       case ".jpeg":
                           addToGroup("Images", file, groupsIndices);
                           break;
                       default:
                            addToGroup("Others", file, groupsIndices);
                            break;
                   }

               }
            }

            batchedWindowCreating(data);

        }


    </script>

</html>
