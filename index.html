<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body onload="initFolders()">
        <div id="title">
            Window 1
        </div>

        <div id="box" ondrop="addFolder(event)" ondragenter="ignoreEvent(event)" ondragover="ignoreEvent(event)">

        </div>

    </body>

    <script>

        var shell = require("shell")
        var fse = require("fs-extra")

        const remote = require('remote'),
        app = remote.require('app');

        var desktopPath = app.getPath('desktop');


        const Menu = remote.require('menu')
        const MenuItem = remote.require('menu-item')

        let rightClickPosition = null
        let rightClickFolderName = null;

        const menu = new Menu()

        const menuItem = new MenuItem({
          label: 'remove folder',
          click: () => {
              removeFolder();  // remove folder on clicking on remove folder

          }
        })
        menu.append(menuItem)

        var foldersDict = {}; // dictionary holding name to a tuple of old path and new path


        function initFolders(){
            fse.readFile('data.txt', (err, data) => {
              if (err) throw err;
              foldersDict = JSON.parse(data);
              var keys = Object.keys(foldersDict);

              for (var i = 0; i < keys.length; i++ ){
                  var fileName = keys[i];
                  var newFilePath = foldersDict[fileName][1];
                  addFolderButton(fileName, newFilePath);
              }

            });
        }

        // creating the folder and add it to the app
        function addFolderButton(fileName, newFilePath){
            // create the button that links it
            var newFolder = document.createElement("div"); // a div holding the button and the name of it
            newFolder.id = fileName;  // the id is the same name as the file
            newFolder.className = "folder";

            var fileNameElement = document.createElement("div");  // to have the name of the file
            fileNameElement.className = "fileNameElement";
            fileNameElement.innerHTML = fileName;

            var newFolderButton = document.createElement("button"); // the button that will run on clicking it
            newFolderButton.className = "folderButton";

            newFolder.addEventListener('contextmenu', (e) => { // right click action
              e.preventDefault()
              rightClickPosition = {x: e.x, y: e.y}
              rightClickFolderName = e['target'].parentNode.id;  // the name of the folder
              menu.popup(remote.getCurrentWindow()) // show the menu
            }, false)


            newFolderButton.onclick=function(){
                shell.openItem(newFilePath)  // opens it in the new file name
            }

            newFolder.appendChild(newFolderButton);
            newFolder.appendChild(fileNameElement);

            document.querySelector("#box").appendChild(newFolder);
        }

        // function that runs on the drop event to add the folder button
        function addFolder(event){
            event.preventDefault();

            var filePath = event.dataTransfer.files[0].path; // the original path of the file

            var fileName = filePath.split("/");
            var fileName = fileName[fileName.length - 1];

            var newFilePath = desktopPath + "/test/" + fileName;    // the new path (inside a folder on the desktop)

            fse.move(filePath, newFilePath, function (err) {  // move from original location to the new one
                  if (err) return console.error(err)
                  console.log("success!")
            })

            addFolderButton(fileName, newFilePath);

            foldersDict[fileName] = [filePath, newFilePath]; //tuple of the orginal path and new path
        }

        function removeButton(buttonName) {
          var elem = document.getElementById(buttonName);
          elem.parentNode.removeChild(elem);
          return false;
        }

        //function to remove folder from window and put it back on desktop
        function removeFolder(){

          fse.move(foldersDict[rightClickFolderName][1], foldersDict[rightClickFolderName][0], function (err) {  // move from original location to the new one
                if (err) return console.error(err)
                delete foldersDict[rightClickFolderName];
                console.log("success!")
          })

          // Now remove the button
          //TO DO: Pass the button name
          removeButton(rightClickFolderName);

        }

        function ignoreEvent(event){
            event.preventDefault();
        }

        window.onbeforeunload = function onbeforeunload() {
            console.log('>>>> onbeforeunload called');

            fse.writeFile("data.txt", JSON.stringify(foldersDict), function(err) {
                if(err) {
                    return console.log(err);
                }

                console.log("The file was saved!");
            });
            return true;
        };

    </script>

</html>
