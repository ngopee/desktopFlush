<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body onload="initFolders()">

        <div id="title" onmouseover="showSettings()" onmouseout='hideSettings()' ondblclick="enableTitleChange()" >
            <input type="text" id="titleText" value="Window 1" disabled="disabled"  onfocusout="saveNewTitle()"/>
            <div id="settingsButton" onclick="showSettingsMenu()" >
                S
            </div>
        </div>

        <div id="box" ondrop="addFolder(event)" ondragenter="ignoreEvent(event)" ondragover="ignoreEvent(event)">

        </div>

    </body>

    <script>

    // dependencies
        const shell = require("electron").shell
        const chokidar = require("chokidar");
        const fse = require("fs-extra")
        const remote = require('electron').remote;
        const app = remote.app;
        const notifier = require('node-notifier');

        var desktopPath = app.getPath('desktop');

        var groupName;

        /////////////////////////////////////////////

        var path = desktopPath + "/test/";

         var watcher = chokidar.watch(path, {
             ignored: /[\/\\]\./,
             persistent: true,
             depth: 2
         });

         function onWatcherReady(){
             console.info('From here can you check for real changes, the initial scan has been completed.');
         }


        //  // Declare the listeners of the watcher
         watcher
         .on('add', function(path) {
               console.log('File', path, 'has been added');
         })
         .on('addDir', function(path) {
               console.log('Directory', path, 'has been added');
         })
         .on('change', function(path) {
              console.log('File', path, 'has been changed');
         })
         .on('unlink', function(path) {
              console.log('File', path, 'has been removed');
         })
         .on('unlinkDir', function(path) {
              console.log('Directory', path, 'has been removed');
         })
         .on('error', function(error) {
              console.log('Error happened', error);
         })
         .on('ready', onWatcherReady)
         .on('raw', function(event, path, details) {
              // This event should be triggered everytime something happens.
              console.log('Raw event info:', event, path, details);
         });

        ////////////////////////////////////////////

        // Menus

        const {Menu, MenuItem} = remote

        let rightClickPosition = null
        let rightClickFolderName = null;

        /////// right click menu ////////////
        const menu = new Menu()

        const menuItem = new MenuItem({
          label: 'remove folder',
          click: () => {
              removeFolder();  // remove folder on clicking on remove folder

          }
        })
        menu.append(menuItem)
        /////////////// end of right click menu .////////////

        /////////// settings menu ///////////////////
        const settingsMenu = new Menu();
        const settingsMenuItem = new MenuItem({
            label: 'Add Group',
            click: () => {
                var createWindow = require('electron').remote.require('./main').createWindow;
                var win = createWindow();

            }
        })

        settingsMenu.append(settingsMenuItem);
        //////// end of settings menu //////////////

        var foldersDict = {}; // dictionary holding name to a tuple of old path and new path

        function initFolders(){

            var id = remote.getCurrentWindow().id;

            fse.readFile('data.txt', (err, data) => {
              if (err) throw err;
              if (data == ""){
                  return;
              }
              data = JSON.parse(data);

              console.log(data[id-1]['title']);

              foldersDict = data[id-1]['folders'];

              document.querySelector("#titleText").value = data[id-1]["title"];
              groupName = data[id-1]["title"];

              var keys = Object.keys(foldersDict);

              for (var i = 0; i < keys.length; i++ ){
                  var fileName = keys[i];
                  var newFilePath = foldersDict[fileName][1];
                  addFolderButton(fileName, newFilePath);
              }

            });

        }

        // creating the folder and add it to the app
        function addFolderButton(fileName, newFilePath){
            // create the button that links it
            var newFolder = document.createElement("div"); // a div holding the button and the name of it
            newFolder.id = fileName;  // the id is the same name as the file
            newFolder.className = "folder";

            var fileNameElement = document.createElement("div");  // to have the name of the file
            fileNameElement.className = "fileNameElement";
            fileNameElement.innerHTML = fileName;

            var newFolderButton = document.createElement("button"); // the button that will run on clicking it
            newFolderButton.className = "folderButton";

            newFolder.addEventListener('contextmenu', (e) => { // right click action
              e.preventDefault()
              rightClickPosition = {x: e.x, y: e.y}
              rightClickFolderName = e['target'].parentNode.id;  // the name of the folder
              menu.popup(remote.getCurrentWindow()) // show the menu
            }, false)

            var c = this;
            newFolderButton.ondblclick = function(){
                var newFilePath = desktopPath + "/test/" + groupName + "/" + fileName;    // the new path (inside a folder on the desktop)

                console.log(newFilePath);
                shell.openItem(newFilePath)  // opens it in the new file name path
            }

            newFolderButton.onclick = function(){
                newFolder.style.backgroundColor = "red";
            }


            newFolder.appendChild(newFolderButton);
            newFolder.appendChild(fileNameElement);

            document.querySelector("#box").appendChild(newFolder);
        }

        // function that runs on the drop event to add the folder button
        function addFolder(event){
            event.preventDefault();

            var filePath = event.dataTransfer.files[0].path; // the original path of the file

            var fileName = filePath.split("/");
            var fileName = fileName[fileName.length - 1];

            var newFilePath = desktopPath + "/test/" + groupName + "/" + fileName;    // the new path (inside a folder on the desktop)

            fse.move(filePath, newFilePath, function (err) {  // move from original location to the new one
                  if (err) return console.error(err)
                  console.log("success!")
            })

            addFolderButton(fileName, newFilePath);

            foldersDict[fileName] = [filePath, newFilePath]; //tuple of the orginal path and new path
        }

        function removeButton(buttonName) {
          var elem = document.getElementById(buttonName);
          elem.parentNode.removeChild(elem);
          return false;
        }

        //function to remove folder from window and put it back on desktop
        function removeFolder(){
            var oldPath = foldersDict[rightClickFolderName][0];
            var newPath = foldersDict[rightClickFolderName][1];
          fse.move(newPath, oldPath, function (err) {  // move from original location to the new one
                if (err) return console.error(err)
                delete foldersDict[rightClickFolderName]; // delete the folder from the dictionary

                notifier.notify({
                  title: 'Desktop Flush',
                  message: rightClickFolderName + " moved to " + newPath,

                }, function (err, response) {
                  // Response is response from notification
                });

          })

          // Now remove the button
          removeButton(rightClickFolderName);

        }

        // to ignore events
        function ignoreEvent(event){
            event.preventDefault();
        }


        // show settings button when hovering over the title
        function showSettings(){
            document.querySelector("#settingsButton").style.visibility = 'visible';
        }

        // hide settings button when outside the title bar
        function hideSettings(){
            document.querySelector("#settingsButton").style.visibility = 'hidden';
        }

        function showSettingsMenu(){
            settingsMenu.popup(remote.getCurrentWindow()) // show the menu
        }

        function enableTitleChange(){
            document.getElementById("titleText").disabled="";
        }

        // to save the new group name
        function saveNewTitle(){
            document.getElementById("titleText").disabled="true";

            var updatedTitle = document.querySelector("#titleText").value;

            var oldName = desktopPath + "/test/" + groupName;
            var newName = desktopPath + "/test/" + updatedTitle;

            fse.rename(oldName, newName, function(err){
                if (err) throw err;
            });

            groupName = updatedTitle;
        }



        window.onbeforeunload = function onbeforeunload() {
            var data = [{'folders':foldersDict, 'title': groupName}];

            fse.writeFile("data.txt", JSON.stringify(data), function(err) {
                if(err) {
                    return console.log(err);
                }

                console.log("The file was saved!");
            });
            
        };

    </script>


</html>
